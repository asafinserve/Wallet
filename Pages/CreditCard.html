<!DOCTYPE html>
<head>
   <title>Credit Card</title>
   <link rel="icon" href="../Assets/main-icon.png">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
</head>
<style>
   .centre
   {
   text-align: center;
   }
   .button {
   padding: 15px 25px;
   font-size: 20px;
   text-align: center;
   cursor: pointer;
   outline: none;
   color: #fff;
   background-color: peru;
   border: none;
   border-radius: 15px;
   box-shadow: 0 9px #999;
   }
   .button:hover {background-color: darkgoldenrod}
   .button:active {
   background-color: peru;
   box-shadow: 0 5px #666;
   transform: translateY(4px);
   }
   .content {
   padding: 0 18px;
   display: none;
   overflow: hidden;
   }
   .center{
   margin: auto;
   width: 30%;
   align-items: center;  
   padding: 10px;
   }   
</style>
<body>
   <h2 class="centre">Wallet: Credit Cards</h2>
   <p class="centre" id="cur_balance" style="font-size: 20px;"></p>
   <form class="centre">
      <button class="button" onclick="money_in()">Bill Payment of a card</button>
      <br><br>
      <button class="button" onclick="money_out()">Transaction using a card</button>
   </form>
   <div id="details_div" class="margin: auto;
      display: block;
      ">
      <h2 class="centre">Transactions</h2>      
      <table id="transactions_table" class="center" border="1">
         <tr>
            <th style="margin-left: 10px; margin-right:10px;">Date</th>
            <th style="margin-left: 10px; margin-right:10px;">Particulars</th>
            <th style="margin-left: 10px; margin-right:10px;">Credit Card</th>
            <th style="margin-left: 10px; margin-right:10px;">Type</th>
            <th style="margin-left: 10px; margin-right:10px;">Amount</th>
            <th style="margin-left: 10px; margin-right:10px;">Paid using Account</th>
            <th style="margin-left: 10px; margin-right:10px;">Narration</th>
         </tr>
      </table>
      
   </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<script>
    function addDarkmodeWidget() {
      const options = {
    bottom: '32px', // default: '32px'
    right: '32px', // default: '32px'
    left: 'unset', // default: 'unset'
    time: '0.5s', // default: '0.3s'
    mixColor: '#fff', // default: '#fff'
    backgroundColor: '#fff',  // default: '#fff'
    buttonColorDark: '#100f2c',  // default: '#100f2c'
    buttonColorLight: '#fff', // default: '#fff'
    saveInCookies: true, // default: true,
    label: 'ðŸŒ“', // default: ''
    autoMatchOsTheme: true // default: true
  }
  
  const darkmode = new Darkmode(options);
  darkmode.showWidget();
    }
    window.addEventListener('load', addDarkmodeWidget);
  </script>
<script>    
function isStatementGeneratedForMonth(transactions, month, year) {
  for (const transaction of transactions) {
    if (
      transaction.Particulars === "Statement generated" &&
      transaction.Date.startsWith(`${year}-${month}`)
    ) {
      return true;
    }
  }
  return false;
}

    data = JSON.parse(localStorage.getItem("CREDIT CARDS"))
    for(var keeey in data)
    {
        if(keeey=="TRANSACTIONS"||keeey=="NO_OF_CARDS")
        {
            
        }
        else
        {
            currentDate = data[keeey]["DueDate"]
            curre = new Date();
            orrr = new Date(currentDate)
            cccc = new Date(currentDate);
            if(curre>=cccc)
            {
                cccc.setMonth(cccc.getMonth()+1)
                if(cccc.getMonth()==0)
                {
                    cccc.setFullYear(cccc.getFullYear()+1)
                }

                trrr = data["TRANSACTIONS"]           
                let statementGenerated = isStatementGeneratedForMonth(trrr, new Date().getMonth()+1, new Date().getFullYear())
                if(statementGenerated==false)
                {
                    new_object = new Object()
                    tobewritten = `${orrr.getFullYear()}-${orrr.getMonth()+1}-${orrr.getDate()}`
                    new_object.Date = tobewritten
                    new_object.Particulars = "Statement generated"
                    new_object.CreditCard = keeey
                    new_object.Amount = data[keeey]["BalanceOutstanding"]
                    new_object.Type=""
                    new_object.Narration=""
                    data["TRANSACTIONS"].push(new_object)
                    data[keeey]["DueDate"]=cccc.toString()
                    localStorage.setItem("CREDIT CARDS", JSON.stringify(data))
                    alert(`Statement generated for ${keeey}. Amount to be paid is â‚¹${parseInt(data[keeey]["BalanceOutstanding"])}`)
                    break;
                }
            }
        }
    }
    selected = ""
   function isStringInList(string, list) {
       var lowercaseString = string.toLowerCase();
       return list.map(item => item.toLowerCase()).includes(lowercaseString);
       }

   
   function moneyadded_in()
   {
       event.preventDefault()
       if(selected=="" || document.getElementById("amount_transaction").value=="" || document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text=="Select a credit card")
       {
           alert("Please enter all the details. The narration is optional")
       }
       else
       {
           data = JSON.parse(localStorage.getItem("CREDIT CARDS"))
           new_object = new Object()
           
           new_object.Type = "Cr"
           new_object.Particulars="Payment made to Card"
           new_object.Amount = document.getElementById("amount_transaction").value
           if(selected=="Cash")
           {
                data_cash = JSON.parse(localStorage.getItem("CASH"))
                cash_balance_to = parseFloat(data_cash["CASH_BALANCE"])
                if (cash_balance_to<parseFloat(document.getElementById("amount_transaction").value))
                {
                        alert(`Insufficient cash balance`)
                }
                else
                {
                    new_object.Account="Cash"
                    new_object.CreditCard = (document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text).split(" - ")[0]
                    new_cashbalance = cash_balance_to-parseFloat(document.getElementById("amount_transaction").value)
                    new_cashobject = new Object()
                    new_cashobject.Date = `${new Date().getFullYear()}-${new Date().getMonth()+1}-${new Date().getDate()}`
                    new_cashobject.Particulars = `Payment of ${(document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text).split(" - ")[0]} Credit Card`
                    new_cashobject.Type = "Dr"
                    new_cashobject.Amount = document.getElementById("amount_transaction").value
                    new_cashobject.Narration = document.getElementById("narration").value
                    data_cash["TRANSACTIONS"].push(new_cashobject)
                    data_cash["TRANSACTIONS"].sort((a, b) => new Date(a.Date) - new Date(b.Date));
                    data_cash["CASH_BALANCE"]=new_cashbalance
                    localStorage.setItem("CASH", JSON.stringify(data_cash))
                }
           }
           else
           {
                bankname = selected.split(" - ")[0]
                data_banks = JSON.parse(localStorage.getItem("BANKS"))
                bank_balance = parseFloat(data_banks[bankname])
                if (bank_balance<parseFloat(document.getElementById("amount_transaction").value))
                {
                        alert(`Insufficient balance in ${bankname}`)
                }
                else
                {
                    new_bankbalance = bank_balance-parseFloat(document.getElementById("amount_transaction").value)
                    new_cashobject = new Object()
                    new_cashobject.Date = `${new Date().getFullYear()}-${new Date().getMonth()+1}-${new Date().getDate()}`
                    new_object.Account = bankname
                    new_cashobject.Particulars = `Payment of ${(document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text).split(" - ")[0]} Credit Card`
                    new_cashobject.Type = "Dr"
                    new_cashobject.BankAccount = bankname
                    new_object.CreditCard = (document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text).split(" - ")[0]
                    new_cashobject.Amount = document.getElementById("amount_transaction").value
                    new_cashobject.Narration = document.getElementById("narration").value
                    data_banks["TRANSACTIONS"].push(new_cashobject)
                    data_banks["TRANSACTIONS"].sort((a, b) => new Date(a.Date) - new Date(b.Date));
                    data_banks[bankname]=new_bankbalance
                    localStorage.setItem("BANKS", JSON.stringify(data_banks))
                }
           }
           
            new_object.Narration = document.getElementById("narration").value
            data["TRANSACTIONS"].push(new_object)
            data["TRANSACTIONS"].sort((a, b) => new Date(a.Date) - new Date(b.Date));
            balance_outstanding = parseFloat(document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text.split(" - â‚¹")[1])-parseFloat(document.getElementById("amount_transaction").value)
            
            data[document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text.split(" - ")[0]]["BalanceOutstanding"]=balance_outstanding
            localStorage.setItem("CREDIT CARDS", JSON.stringify(data))
            alert("Added!")
            window.location.reload();
           
           
       }
   }
   function money_in()
   {
       event.preventDefault()
       document.getElementById("details_div").innerHTML=""
       document.getElementById("details_div").innerHTML+='\
       <h2 class="centre">Bill Payment of a Card</h2>\
       <br><select id="bank_select" class="margin: auto; display: block;" onchange="doTask()"><option>Select a credit card</option></select>\
       <br><input id="amount_transaction" class="margin: auto; display: block;" type="number" placeholder="Enter the bill amount">\
       <br><ul id="list1"></ul>\
       <br><label class="margin: auto; display: block;">How did you pay the amount?</label>\
       <br><ul id="list"></ul>\
       <br><input id="narration" class="margin: auto; display: block;" type="text" placeholder="Enter narration"></p>\
       <br><button id="add_btn"onclick="moneyadded_in()">Add transaction</button>'
       data = JSON.parse(localStorage.getItem("CREDIT CARDS"))
        
        for (keey in data)
        {
            if(keey == "NO_OF_CARDS"|| keey=="TRANSACTIONS")
            {

            }
            else
            {
                var newElement = document.createElement("option")
                newElement.innerHTML = keey
                document.getElementById("bank_select").add(newElement)
            }
        }
       if (localStorage.getItem("CASH")==null && localStorage.getItem("BANKS")==null)
       {
        document.getElementById("list").innerHTML="You don't have any payment options set up"
        document.getElementById("add_btn").disabled = true
       }
       else
       {
         try_cash = JSON.parse(localStorage.getItem("CASH"))
         if(try_cash==null)
         {

         }
         else
         {
            var li = document.createElement("button")
            li.innerHTML = `Cash - â‚¹${try_cash["CASH_BALANCE"]}`
            li.addEventListener("click", function(){selected="Cash"})
            document.getElementById("list").appendChild(li)   
            document.getElementById("list").appendChild(document.createElement("br"))
            document.getElementById("list").appendChild(document.createElement("br"))
         }
         try_bank = JSON.parse(localStorage.getItem("BANKS"))
         if(try_bank==null)
         {

         }
         else
         {
            for (var kkkeey in try_bank)
            {
                if(kkkeey=="NO_OF_BANKACCOUNTS"||kkkeey=="TRANSACTIONS")
                {
                    
                }
                else
                {
                    var li = document.createElement("button")
                    li.innerHTML = `${kkkeey} - â‚¹${try_bank[kkkeey]}`
                    li.addEventListener("click", function(){selected=li.innerHTML})
                    document.getElementById("list").appendChild(li)  
                    document.getElementById("list").appendChild(document.createElement("br"))
                    document.getElementById("list").appendChild(document.createElement("br"))   
                }
            }
         }
       }
    }
    function doTask()
    {
        data = JSON.parse(localStorage.getItem("CREDIT CARDS"))
        
        for (keey in data)
        {
            if(keey==(document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text).split(" - ")[0])
            {
                
                balance = data[keey]["BalanceOutstanding"]
                document.getElementById("amount_transaction").value=balance
                if(balance==0)
                {
                    document.getElementById("add_btn").disabled=true
                }
                else
                {
                    document.getElementById("add_btn").disabled=false
                }
            }
        }
    }
   function moneyadded_out()
   {
       event.preventDefault()
       if(document.getElementById("date_transaction").value=="" || document.getElementById("particulars_transaction").value=="" || document.getElementById("amount_transaction").value=="" || document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text=="Select a credit card")
       {
           alert("Please enter all the details. The narration is optional")
       }
       else
       {
           data = JSON.parse(localStorage.getItem("CREDIT CARDS"))
           new_object = new Object()
           new_object.Date = document.getElementById("date_transaction").value
           new_object.Particulars = document.getElementById("particulars_transaction").value
           if(localStorage.getItem("particulars_ai")==null)
           {
               array_part =[]
               array_part.push(document.getElementById("particulars_transaction").value)
               localStorage.setItem("particulars_ai", JSON.stringify(array_part))
           }
           else
           {
               array_part=JSON.parse(localStorage.getItem("particulars_ai"))
               if(isStringInList(document.getElementById("particulars_transaction").value, array_part)==true)
               {}
               else
               {
                   array_part.push(document.getElementById("particulars_transaction").value)
                   localStorage.setItem("particulars_ai", JSON.stringify(array_part))
               }
           }
           new_object.Type = "Dr"
           new_object.Amount = document.getElementById("amount_transaction").value
           creditcardd = (document.getElementById("bank_select").options[document.getElementById("bank_select").selectedIndex].text)
           new_object.CreditCard = creditcardd
           bankname = creditcardd
           new_object.Narration = document.getElementById("narration").value
           data["TRANSACTIONS"].push(new_object)
           data["TRANSACTIONS"].sort((a, b) => new Date(a.Date) - new Date(b.Date));
           cur_balance = data[bankname]["BalanceOutstanding"]
           cur_balance+=parseFloat(document.getElementById("amount_transaction").value)
           data[bankname]["BalanceOutstanding"] = cur_balance
           localStorage.setItem("CREDIT CARDS", JSON.stringify(data))
           alert("Added!")
           window.location.reload();
       }
   }
   function money_out()
   {
       event.preventDefault()
       document.getElementById("details_div").innerHTML=""
       document.getElementById("details_div").innerHTML+='\
       <h2 class="centre">Transaction made using card</h2>\
       <form><label>Enter the date of the transaction</form><input id="date_transaction" class="margin: auto; display: block;" type="date" placeholder="Enter the date of the transaction"></form>\
       <br><input id="particulars_transaction" class="margin: auto; display: block;" type="text" placeholder="Where did you spent this?">\
       <br><ul id="list"></ul>\
       <br><input id="amount_transaction" class="margin: auto; display: block;" type="number" placeholder="Enter the amount">\
       <br><select id="bank_select" class="margin: auto; display: block;"><option>Select a credit card</option></select>\
       <br><input id="narration" class="margin: auto; display: block;" type="text" placeholder="Enter narration"></p>\
       <br><button onclick="moneyadded_out()">Add transaction</button>'
       data = JSON.parse(localStorage.getItem("CREDIT CARDS"))
        for (keey in data)
        {
            if(keey == "NO_OF_CARDS"|| keey=="TRANSACTIONS")
            {

            }
            else
            {

                var newElement = document.createElement("option")
                newElement.innerHTML = keey
                document.getElementById("bank_select").add(newElement)
            }
            
        }
       if (localStorage.getItem("particulars_ai")==null)
       {
   
       }
       else
       {
           var listItems = JSON.parse(localStorage.getItem("particulars_ai"))
   var listElement = document.getElementById('list');
   var searchInput = document.getElementById('particulars_transaction');
   
   // Function to filter the list based on search input
   function filterList() {
     var searchValue = searchInput.value.toLowerCase();
     var filteredList = listItems.filter(function(item) {
       return item.toLowerCase().includes(searchValue);
     });
     renderList(filteredList);
   }
   function addText(text)
   {
       document.getElementById("particulars_transaction").value = text
   }
   // Function to render the list
   function renderList(items) {
     listElement.innerHTML = '';
     items.forEach(function(item) {
       var li = document.createElement('li');
       li.textContent = item;
       li.addEventListener("click", function(){addText(li.textContent)})
       listElement.appendChild(li);
     });
   }
   
   // Event listener for search input
   searchInput.addEventListener('input', filterList);
   
   // Initial list rendering
   renderList(listItems);
       }
   }
   
   if(localStorage.getItem("CREDIT CARDS")==null)
   {
       alert("You have not setup a credit card. Please add atleast 1 credit card")
       window.location.href="Signup.html"
   }
   else
   {
           
       if(data["TRANSACTIONS"].length==0)
       {
           document.getElementById("transactions_table").style.visibility="hidden"
           var no_trx = document.createElement("h2")
           no_trx.innerHTML="No transactions found"
           no_trx.style.cssText = 'text-align:center;';
           document.getElementById("details_div").appendChild(no_trx)
           
       }
       else
       {
           data = JSON.parse(localStorage.getItem("CREDIT CARDS"))
           trx = data["TRANSACTIONS"]
           trx.forEach(add)
       }
   }
   function add(item)
   {
       var newRow = document.createElement("tr")
       var newDate = document.createElement("td")
       try{
        date = `${item["Date"].split("-")[2]}-${item["Date"].split("-")[1]}-${item["Date"].split("-")[0]}`
        newDate.innerHTML=date
       }
       catch
       {
        newDate.innerHTML=""
       }
       
       var newParticulars = document.createElement("td")
       newParticulars.innerHTML=item["Particulars"]
       var newBank = document.createElement("td")
       newBank.innerHTML=(item["CreditCard"]).split(" - ")[0]

       var newType = document.createElement("td")
       newType.innerHTML=item["Type"]
       var newAmount = document.createElement("td")
       newAmount.innerHTML=item["Amount"]
       var newAccount = document.createElement("td")
       if(item["Account"]==undefined)
       
       {
        newAccount.innerHTML="N/A"
       }
       else
       {
        newAccount.innerHTML=item["Account"]
       }
       var newNarration = document.createElement("td")
       newNarration.innerHTML=item["Narration"]
       newRow.appendChild(newDate)
       newRow.appendChild(newParticulars)
       newRow.appendChild(newBank)
       newRow.appendChild(newType)
       newRow.appendChild(newAmount)
       newRow.appendChild(newAccount)
       newRow.appendChild(newNarration)
       document.getElementById("transactions_table").appendChild(newRow)   
   }
   var recommend = document.createElement("h2")
    recommend.innerHTML="Recommended card to use:"
    recommend.style.cssText = 'text-align:center;';
    document.getElementById("details_div").appendChild(recommend)
    var card_to_use = document.createElement("p")
    card_to_use.style.cssText="text-align:center;";
    card_to_use.id="card_to_use"
    document.getElementById("details_div").appendChild(card_to_use)
    data = JSON.parse(localStorage.getItem("CREDIT CARDS"))
    const cardDetails = Object.entries(data)
    .filter(([key]) => key !== "NO_OF_CARDS" && key !== "TRANSACTIONS")
    .map(([card, details]) => ({
        card,
        dueDate: new Date(details.DueDate),
        balance: details.BalanceOutstanding
    }));
    // another = cardDetails
    cardDetails.sort((a, b) => a.dueDate - b.dueDate);
       function determineCard(item, dda)
       {
        const today = new Date("2023-08-05");
        dda.setMonth(today.getMonth());
        if(today>=dda)
        {
            document.getElementById("card_to_use").innerHTML+=`Statement for ${item} has been generated, and thus can be used<br><br>`
        }
        else
        {
            document.getElementById("card_to_use").innerHTML+=`Statement for ${item} has not been generated, and we recommend you not to use it until ${dda.getDate()}-${dda.getMonth()+1}-${dda.getFullYear()}. If you use ${item} now, you will have to pay the amount on the bill generating on ${dda.getDate()}-${dda.getMonth()+1}-${dda.getFullYear()}<br><br>`
        }
    }


cardDetails.forEach(({ card, dueDate }) => {
const formattedDate = `${dueDate.getDate()}-${dueDate.getMonth()+1}-${dueDate.getFullYear()}`
document.getElementById("cur_balance").innerHTML+=`${card}: ${formattedDate}<br>`

});
another = cardDetails

another.sort((a, b) => new Date(b.dueDate) - new Date(a.dueDate));
another.forEach(({card, dueDate})=>{
    determineCard(card, dueDate)
})
</script>
</body>


</html>
